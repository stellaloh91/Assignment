---
title: "Data Exploration"
description: |
  Visual exploration of data provided
output: 
  distill::distill_article:
    toc: true
    toc_float: true
    toc_depth: 3
    self_contained: false
---
<style>

body{
  background-color: #EBEDEF;
  font-family:helvetica;
  font-size: 20pt
}
</style>

```{r setup, include=FALSE, layout="l-body-outset"}
knitr::opts_chunk$set(fig.retina = 3,
                      echo = FALSE,
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

## Data Preparation

All data extraction and wrangling are done in R using the tidyverse suite of packages.

### Install and load all necessary packages

The code chunk below is used to install and load packages for data preparation and exploration process:

```{r}
packages = c('raster','clock', 'tmap', 'tidyverse', 'sf', 'readr', 'dplyr', 'plotly', 'tidyr', 'lubridate', 'gridExtra', 'knitr', 'stringr', 'ggplot2', 'crosstalk', 'DT', 'RColorBrewer', 'igraph', 'tidygraph', 'ggraph', 'visNetwork', 'mapview')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

### Import relevant data

The data provided consists of four CSV files, a tourist map and geospatial data files- read_csv() is used to import each CSV file into R. 

Data source       | Data
----------------------------------------------------------------------------------------------------|
cc_data           | Timestamp and transaction amount of credit cards at each location               |
loyalty_data      | Timestamp and transaction amount of loyalty cards at each location              |
car-assignments   | Name, employment type and employment title of each employee assigned to a carID |
gps               | Latitude and longitude of each carID for each timestamp                         |
geospatial data   | Geospatial data files, including shapefiles                                     |

We note that there are some issues with the imported data:
    - Timestamp data is presented in character instead of datetime format
    - last4ccnum is in double format instead of factor
    - ID and CarID are in double format instead of factor

We will correct the issues above in the next section.

```{r}
##Import data
loyalty_data <- read_csv("data/loyalty_data.csv")
glimpse(loyalty_data)

cc_data <- read_csv("data/cc_data.csv")
glimpse(cc_data)

gps_data <- read_csv("data/aspatial/gps.csv")
glimpse(gps_data)

assignment_data <- read_csv("data/car-assignments.csv")
glimpse(assignment_data)
```

### Wrangle the data

Before working on the data frames, we need to explore and prepare each data frame.

```{r}
##Loyalty data
loyalty_data$timestamp <- date_time_parse(loyalty_data$timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y") 

loyalty_data_cleaned <- loyalty_data %>%
  mutate(weekday = weekdays(timestamp), day = get_day(timestamp)) %>%
  rename("date" = "timestamp") 

loyalty_data_cleaned$location <- iconv(loyalty_data_cleaned$location, to='ASCII//TRANSLIT')
loyalty_data_cleaned
```

```{r}
# Credit card data
cc_data$timestamp <- date_time_parse(cc_data$timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y %H:%M")

cc_data_cleaned <- cc_data %>% 
  mutate(date = as_date(cc_data$timestamp), weekday = weekdays(timestamp), day = get_day(timestamp), hour = get_hour(cc_data$timestamp)) 

cc_data_cleaned$location <- iconv(cc_data_cleaned$location, to='ASCII//TRANSLIT')
cc_data_cleaned$last4ccnum = as_factor(cc_data_cleaned$last4ccnum)
cc_data_cleaned
```

```{r}
# GPS data
gps_data$Timestamp <- date_time_parse(gps_data$Timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y %H:%M:%S")
gps_data$id <- as_factor(gps_data$id)
gps_data
```

```{r}
# Assignment data
assignment_data$CarID <- as_factor(assignment_data$CarID)
assignment_data
```

After cleaning the individual data frames, we can now proceed to combine the GPS and car assignment data in a single data frame.

```{r}
# Join gps and assignment data using full join
location_carid_join <- gps_data %>%
  full_join(assignment_data, by = c("id" = "CarID")) %>% 
  mutate(date = as_date(Timestamp), day = as_weekday(Timestamp), hour = get_hour(Timestamp)) 
```

The dataset is now ready for data exploration.

## Explore the data

We will first perform exploratory data analysis, employing visualization to aid in the exploration of the following areas:
    - Missing values
    - Distribution
    - Outliers

### Missing values
```{r, layout="l-body-outset", fig.width=5.5, fig.height=5}
##loyalty card
missing.values_loyalty <- loyalty_data_cleaned %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)

levels_loyalty <- (missing.values_loyalty %>% filter(isna == T) %>% arrange(desc(pct)))$key

percentage.plot_loyalty <- missing.values_loyalty %>%
      ggplot() +
        geom_bar(aes(x = reorder(key, desc(pct)), 
                     y = pct, fill=isna, text= sprintf("Percent: %s", scales::percent(pct, scale = 1, accuracy = .01))), 
                 stat = 'identity', alpha=0.8) +
      scale_x_discrete(limits = NULL) +
      scale_fill_manual(name = "", 
                        values = c('steelblue', 'tomato3'), labels = c("Present", "Missing")) +
      coord_flip() +
      labs(title = "Percentage of missing values- loyalty card data", x =
             'Variable', y = "% of missing values") + 
      theme(legend.position = "none") 

ggplotly(percentage.plot_loyalty, tooltip = c("text"))
```

```{r, layout="l-body-outset", fig.width=5.5, fig.height=5}
##credit card
missing.values_cc <- cc_data_cleaned %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)

levels_cc <- (missing.values_cc %>% filter(isna == T) %>% arrange(desc(pct)))$key

percentage.plot_cc <- missing.values_cc %>%
      ggplot() +
        geom_bar(aes(x = reorder(key, desc(pct)), 
                     y = pct, fill=isna, text= sprintf("Percent: %s", scales::percent(pct, scale = 1, accuracy = .01))), 
                 stat = 'identity', alpha=0.8) +
      scale_x_discrete(limits = NULL) +
      scale_fill_manual(name = "", 
                        values = c('steelblue', 'tomato3'), labels = c("Present", "Missing")) +
      coord_flip() +
      labs(title = "Percentage of missing values- credit card data", x =
             'Variable', y = "% of missing values") + 
      theme(legend.position = "none") 

ggplotly(percentage.plot_cc, tooltip = c("text"))
```

```{r, layout="l-body-outset", fig.width=5.5, fig.height=5}
##location data
missing.values_gps_carid <- location_carid_join %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)

percentage.plot_gps_carid <- missing.values_gps_carid  %>%
      ggplot(aes(x = reorder(key, desc(pct)), 
                     y = pct, fill=isna, text= sprintf("Percent: %s", scales::percent(pct, scale = 1, accuracy = .001)))) +
        geom_bar(stat = 'identity', alpha=0.8) +
        geom_text(aes(label= sprintf("%0.3f %%", round(pct, digits = 3))), position=position_stack(vjust=1), color="black", size=3.5, check_overlap = T) +
      scale_x_discrete(limits = NULL) +
      scale_fill_manual(name = "", values = c('steelblue', 'tomato3'), labels = c("Present", "Missing")) +
      coord_flip() +
      labs(title = "Percentage of missing values- location data", x =
             'Variable', y = "% of missing values") + 
      theme(legend.position = "none") 

ggplotly(percentage.plot_gps_carid, tooltip = c("text"))
```

From the above plots, we note that there is no missing values in both the loyalty and credit card data.
However, there appears to be missing values in the location data provided. 

From the above plot, LastName, FirstName, CurrentEmploymentType and CurrentEmploymentTitle have the highest percentage of missing values, followed other variables in the combined GPS and car assignment data dataset. As the missing values would not pose a problem later in the analysis, we will not be performing imputation at this stage.

### Distribution

The distributions are examined from the density curves of the variables using ggplot().

```{r}
##loyalty card
check_distribution_loyalty <- loyalty_data_cleaned %>%
  ggplot(aes(x=price)) +
  geom_density() +
  ggtitle("Distribution of loyalty card spending") +
  theme_minimal() +
  theme(panel.border = element_rect(colour="grey60", fill = NA),
        strip.background = element_rect(fill = "grey80"))
```

```{r}
##credit card
check_distribution_cc <- cc_data_cleaned %>%
  ggplot(aes(x=price)) +
  geom_density() +
  ggtitle("Distribution of credit card spending") +
  theme_minimal() +
  theme(panel.border = element_rect(colour="grey60", fill = NA),
        strip.background = element_rect(fill = "grey80"))

ggplotly(check_distribution_loyalty)
ggplotly(check_distribution_cc)
```

From the above distributions, we can see that the range of values differ greatly. In order to observe the distributions clearly, we will re-scale the data using log transformation. 

```{r}
##loyalty card
check_distribution_loyalty_log <- loyalty_data %>%
  ggplot(aes(x=price)) +
  geom_density() +
  theme_minimal() +
  theme(panel.border = element_rect(colour="grey60", fill = NA),
        strip.background = element_rect(fill = "grey80")) + 
  scale_x_log10() +
  labs(title = "Distribution of loyalty card spending after log transformation", x = 'price (log scale)', y = "density")
```

```{r}
##credit card
check_distribution_cc_log <- cc_data %>%
  ggplot(aes(x=price)) +
  geom_density() +
  theme_minimal() +
  theme(panel.border = element_rect(colour="grey60", fill = NA),
        strip.background = element_rect(fill = "grey80")) + 
  scale_x_log10() +
  labs(title = "Distribution of credit card spending after log transformation", x = 'price (log scale)', y = "density")

ggplotly(check_distribution_loyalty_log)
ggplotly(check_distribution_cc_log)
```

The distributions of the log-transformed variables now approximates to the normal distribution.

We have also plotted the total spent per day in each store for both loyalty and credit card data. As seen in the figures below, the spending differs greatly between stores (note free scales). However, total spending per day from credit card and loyalty card data follows the same trending.

```{r, layout="l-screen-inset shaded", fig.height=10}
##loyalty card
summ_loyalty_data <- loyalty_data_cleaned %>%
  group_by(location, date) %>%
  summarise(total_spent = sum(price))

check_distribution_loyalty_location <- summ_loyalty_data %>%
  ggplot() +
  geom_line(aes(x=date, y = total_spent, group = 1)) +
  facet_wrap(~location, nrow = 11, ncol = 4, scales='free_y') +
  ggtitle("Loyalty card spending per store") +
  scale_x_datetime(date_labels = "%b %d",date_breaks = "2 days") +
  theme_minimal() +
  theme(panel.border = element_rect(colour="grey60", fill = NA),
        strip.background = element_rect(fill = "grey80"),panel.spacing = unit(2, "lines"))

ggplotly(check_distribution_loyalty_location)
```

```{r, layout="l-screen-inset shaded", fig.height=10}
##credit card
summ_cc_data <- cc_data_cleaned %>%
  group_by(location, date) %>%
  summarise(total_spent = sum(price))

check_distribution_cc_location <- summ_cc_data %>%
  ggplot() +
  geom_line(aes(x=date, y = total_spent, group = 1)) +
  facet_wrap(~location, nrow = 11, ncol = 4, scales='free_y') +
  ggtitle("Credit card card spending per store") +
  scale_x_date(date_labels = "%b %d",date_breaks = "2 days") +
  theme_minimal() +
  theme(panel.border = element_rect(colour="grey60", fill = NA),
        strip.background = element_rect(fill = "grey80"),panel.spacing = unit(2, "lines"))
  
ggplotly(check_distribution_cc_location)
```

### Outliers

The outliers are also examined using ggplot().

```{r, layout="l-body-outset", fig.width=5.5, fig.height=5}
##loyalty card
d <- highlight_key(loyalty_data_cleaned)
m <- list(l=50, r=50, b=150, t=0, pad=2)

boxplot_loyalty_plot <- plot_ly(height = 600, d, y = ~location, x = ~price) %>%
  add_boxplot(hoverinfo = "text", hovertext = ~paste("Date:", date,"<br>",
                                "Amount:", price)) %>% 
  layout(xaxis = list(title = "Distribution of loyalty card spending (log scale)", tickangle = 0, ticks = "outside", ticklen = 2, tickwidth = 2, tickcolor = toRGB("black"),showgrid = T, showticklabels = TRUE, zeroline = F,  showline = T, type = "log", range = c(0, 4.1)), margin = m, yaxis = list(dtick= 1)) 

gg <- highlight(ggplotly(boxplot_loyalty_plot), "plotly_selected")
crosstalk::bscols(gg,DT::datatable(d) %>% 
                    formatDate(1, method = 'toLocaleDateString'), widths = 15)
```

```{r, layout="l-body-outset", fig.width=5.5, fig.height=5}
##credit card
cc_data_cleaned$timestamp <- as.character(cc_data_cleaned$timestamp)

d1 <- highlight_key(cc_data_cleaned)

boxplot_cc_plot <- plot_ly(height = 600, d1, y = ~location, x = ~price) %>%
  add_boxplot(hoverinfo = "text", hovertext = ~paste("Date:", date,"<br>",
                                                    "Amount:", price)) %>%
  layout(xaxis = list(title = "Distribution of credit card card spending (log scale)", tickangle = 0, ticks = "outside", ticklen = 2, tickwidth = 2, tickcolor = toRGB("black"), showgrid = T, showticklabels = TRUE, zeroline = F,  showline = T, type = "log", range = c(0, 4.1)), margin = m, yaxis = list(dtick= 1)) 

gg <- highlight(ggplotly(boxplot_cc_plot), "plotly_selected")
crosstalk::bscols(gg,DT::datatable(d1), widths = 15)
```

Using the interactive plots above, we are able to select the outliers and this filters the linked datatable for the relevant transaction, giving additional insight such as the card number. For example, we observe a $10,000 transaction by card ending with 9551 at Frydos Autosupply n'More but not a corresponding transaction on the loyalty card.
