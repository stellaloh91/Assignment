---
title: "Methodology"
description: |
  Step-by-step description of analysis
output: 
  distill::distill_article:
    toc: true
    toc_float: true
    toc_depth: 3
    self_contained: false
---
<style>

body{
  background-color: #EBEDEF;
  font-family:helvetica;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.retina = 3,
                      echo = TRUE,
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

## Methodology and Design

In this section, we will explore the methodology to analyze the data and analyze various packages required to build the plots. The criteria for selection of plots are as follows:
    - Level of customization 
    - Ease of use and implementation of customization 
    - Ease of understanding and interpretation of the plot- both clarity and aesthetic
    - Interactivity

### Methodology

#### Exploratory Visualization
As observed above, popular day of week differs for some of the locations such as Katerina's Cafe. This is unexpected as we would expect the trends to be similar for both cards.

Also, based on the timestamp of credit card transactions, we noted that all of the transactions in "Bean There Done That", "Brewed Awakenings", "Coffee Shack" and "Jack's Magical Beans" during the period of transactions- 12:00pm. It is highly unlikely that all transactions in these locations are transacted at the same time. Hence, the timestamp for these transactions may be incorrect.

Given that these timestamps may not be representative of the actual transaction time, we will not be using this information for further analysis subsequently.

#### GeoVisual Analysis

Assuming that the car assignment list provided includes all employees, we noted that there are 44 distinct employees. However, we noted that there are 55 distinct credit card numbers and 54 distinct loyalty card numbers. This is unusual as each employee should have been issued a loyalty card and hence we would expect number of distinct credit cards, loyalty cards and employee count to match.

More investigation should be made into this discrepancy. One explanation could be that employees could have used more than one credit card with their loyalty card. Another explanation could be that there is a new employee who has not received the loyalty card. Given that the employee count is different from number of distinct loyalty cards, we should check with Gastech if there are any employees missing from this list.

After mapping the GPS trajectories, We also noted that there were no GPS data indicating that any car stopped near "Bean There Done That", "Brewed Awakenings", "Coffee Shack" and "Jack's Magical Beans" during the period of transactions- 12:00pm. Hence, these transactions are either incorrectly timed or may even be fraudulent.



### Design

#### Exploratory Visualization

1) **Transaction volume overview by day**- We have decided to employ the use of a linked bar chart to reflect the volume of transactions across the 2 weeks for each location. Users can then select the location they want specific details on and the linked line chart will then provide the details on transaction volume across time.

```{r, layout="l-body-outset", fig.width=5.5, fig.height=5}
##Volume from loyalty card dataset- not linked
loyalty_data_loc_vol <- loyalty_data_cleaned %>%
  group_by(location) %>%
  summarise(txn_count = n()) %>%
  arrange(desc(txn_count))

loyalty_loc_vol_bar <- plot_ly(loyalty_data_loc_vol, x = ~txn_count, y = ~location, type = "bar", hoverinfo = "text", 
                       text = ~paste("Transaction Volume:", loyalty_data_loc_vol$txn_count)) %>% 
                      layout(title = "Loyalty card transaction Volume by Location", 
                             xaxis = list(title = "Transaction Volume", zeroline = FALSE), 
                             yaxis = list(title = "Location", zeroline = FALSE, categoryorder = "array", dtick= 1, categoryarray = ~txn_count))

loyalty_loc_vol_bar

library(crosstalk)

loyalty_data_count <- loyalty_data_cleaned %>%
  group_by(location, date) %>%
  summarise(txn_count = n()) %>%
  arrange(desc(txn_count))

loyalty_data_count %>% 
  SharedData$new(key = ~location) %>%
  plot_ly(x = ~date, y = ~txn_count, hoverinfo = "text", 
              text = ~paste("Location:", location,"<br>",
                            "Date:", date,"<br>",
                            "Transaction Count:", txn_count), alpha = 0.5) %>%
          group_by(location) %>%
          add_lines()
```


```{r, layout="l-body-outset", fig.width=5.5, fig.height=5}
##Volume from loyalty card dataset by date- linked

library(crosstalk)

shared_data <- SharedData$new(loyalty_data_cleaned, key = ~location)

loyalty_loc_vol_bar <- shared_data %>%
  plot_ly() %>% 
  group_by(location) %>%
  summarise(txn_count = n()) %>%
  arrange(desc(txn_count)) %>%
  add_bars(x = ~txn_count, y = ~location, type = "bar", hoverinfo = "text", 
          text = ~paste("Location:", location,
                        "<br>Transaction Volume:", txn_count)) %>%
  layout(title = "Loyalty card transaction Volume by Location", xaxis = list(title = "Transaction Volume", 
         zeroline = FALSE), yaxis = list(title = "Location", zeroline = FALSE, categoryorder = "array", dtick= 1, categoryarray = ~txn_count))

loyalty_loc_vol_line <- shared_data %>% 
  plot_ly() %>%
  group_by(location, date) %>%
  summarise(txn_count = n()) %>%
  add_lines(x = ~date, y = ~txn_count, hoverinfo = "text", 
          text = ~paste("Location:", location,
                        "<br>Date:", date,
                        "<br>Transaction Volume:", txn_count)) %>%
  layout(xaxis = list(title = "Date", showgrid = TRUE, showticklabels = TRUE), 
         yaxis = list(title = "Transaction volume"))

bscols(widths = c(14,14), loyalty_loc_vol_bar, loyalty_loc_vol_line)
```

```{r, layout="l-body-outset", fig.width=5.5, fig.height=5}
##Volume from credit card dataset by date- linked

cc_data_loc_vol <- cc_data_cleaned %>%
  group_by(location) %>%
  summarise(txn_count = n()) %>%
  arrange(desc(txn_count))

cc_loc_vol_bar <- plot_ly(cc_data_loc_vol, x = ~txn_count, y = ~location, type = "bar", hoverinfo = "text", 
                       text = ~paste("Transaction Volume:", cc_data_loc_vol$txn_count)) %>% 
                      layout(title = "Credit card transaction Volume by Location", xaxis = list(title = "Transaction Volume", zeroline = FALSE), yaxis = list(title = "Location", zeroline = FALSE, dtick= 1, categoryorder = "array", categoryarray = ~txn_count))

cc_loc_vol_bar
```

2) **Overview of transaction volume difference**- provide an overview of the difference in transaction volume across each location per day.

```{r, layout="l-body-outset", fig.width=7.5, fig.height=5.5}
##Difference in volume by day

loyalty_data_count <- loyalty_data_cleaned %>%
  group_by(location, date) %>%
  summarise(txn_count = n()) %>%
  arrange(desc(txn_count))

cc_data_count <- cc_data_cleaned %>%
  group_by(location, date) %>%
  summarise(txn_count = n()) %>%
  arrange(desc(txn_count))

count_loyalty_cc_comb <- loyalty_data_count %>%
  full_join(cc_data_count, by = c("location","date")) %>%
  rename("loyalty_card_txncount" = "txn_count.x", "credit_card_txncount" = "txn_count.y") %>%
  mutate_if(is.numeric , replace_na, replace = 0) %>%
  mutate(difference_vol = loyalty_card_txncount - credit_card_txncount) 

a <- list(
  title = "Difference in volume per day by location",
  showticklabels = TRUE
)

txn_vol_difference_heatmap <- count_loyalty_cc_comb %>%
  plot_ly(x= ~date, y = ~location , z = ~difference_vol, colors = brewer.pal(3, "Blues"), type = "heatmap",   hoverinfo = 'text',
          text = ~paste("Date:", date,
                        "<br> Location:", location,
                        "<br> Vol_Diference:", difference_vol))
txn_vol_difference_heatmap %>% layout(yaxis = a, xaxis = list(
  dtick = "86400000.0",
  type = 'date',
  title = "Date",
  tickangle = 0,
  tickformat = "%d%b"), margin = m, plot_bgcolor="#bdbdbd")
```

3) **Transaction volume overview by day of week**- Similar to 1 above, We have decided to employ the use of a linked bar chart to reflect the volume of transactions by each day of the week for each location. Users can use the interactive filter to select the location they want specific details on and the linked bar chart will then provide the visualization on transaction volume across day of week. The datatable will also be filtered for the relevant location to provide further details like date and price of transaction.

As the transaction time for credit cards is also provided, we have included an additional bar chart which reflects the volume per period of time in the selected location. This will provide more information to assess when the location is popular for each day of the week.

```{r}
##Loyalty card volume by day of week

##Preparing the data
loyalty_data_cleaned$daynumber = lubridate::wday(loyalty_data_cleaned$date, week_start = 1)
loyalty_data_cleaned$weekday = factor(loyalty_data_cleaned$weekday, levels= c("Sunday", "Monday", 
                                             "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))



##Plots
shared_data_loyalty = SharedData$new(loyalty_data_cleaned, key = ~ location)

loyalty_wkday_vol <- shared_data_loyalty %>%
  plot_ly(width=700, height=500) %>%
  group_by(weekday,location) %>%
  summarize(transaction = n()) %>%
  arrange(desc(transaction)) %>%
  add_trace(x = ~weekday, y = ~transaction, color = ~location, type = 'bar',hoverinfo = 'text',
            hovertext  = ~paste("<br> Day_of_week:", weekday,
                          "<br> Transaction Volume:", transaction)) %>%
  layout(xaxis = list(title = "Day_of_week", 
                        type = "factor",
                        categoryorder = "factor",
                        categoryarray = loyalty_data_cleaned$weekday[order(loyalty_data_cleaned[['daynumber']])],
                        showgrid = TRUE,
                        showticklabels = TRUE
                      ), yaxis = list(title = "Transaction volume"))

bscols(widths = c(10,4),
  list(
    filter_select("location", "Please Specify the location", shared_data_loyalty, group =  ~location, multiple = F),
    datatable(shared_data_loyalty) %>% formatDate(1, method = 'toLocaleDateString')),
  loyalty_wkday_vol
)
```

```{r}
## Credit card volume by day of week
## Loading data
Sys.setlocale("LC_TIME", "English")
## Preparing the data
cc_data_cleaned$daynumber = lubridate::wday(cc_data_cleaned$timestamp, week_start = 1)
cc_data_cleaned$weekday = factor(cc_data_cleaned$weekday, levels= c("Sunday", "Monday", 
                                             "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

## Preparing timegroup
cc_data_cleaned$timegroup = ""
cc_data_cleaned$timegroup[cc_data_cleaned$hour < 05 & 00 <= cc_data_cleaned$hour] = "00 - 04"
cc_data_cleaned$timegroup[cc_data_cleaned$hour < 09 & 05 <= cc_data_cleaned$hour] = "05 - 08"
cc_data_cleaned$timegroup[cc_data_cleaned$hour < 13 & 09 <= cc_data_cleaned$hour] = "09 - 12"
cc_data_cleaned$timegroup[cc_data_cleaned$hour < 17 & 13 <= cc_data_cleaned$hour] = "13 - 16"
cc_data_cleaned$timegroup[cc_data_cleaned$hour < 21 & 17 <= cc_data_cleaned$hour] = "17 - 20"
cc_data_cleaned$timegroup[cc_data_cleaned$hour <= 24 & 21 <= cc_data_cleaned$hour] = "21 - 24"

## Plots
shared_data = SharedData$new(cc_data_cleaned, key = ~ location)

cc_wkday_vol <- shared_data %>%
  plot_ly(width=700, height=500) %>%
  group_by(weekday,location) %>%
  summarize(transaction = n()) %>%
  arrange(desc(transaction)) %>%
  add_trace(x = ~weekday, y = ~transaction, color = ~location, type = 'bar',hoverinfo = 'text',
            hovertext  = ~paste("<br> Day_of_week:", weekday,
                          "<br> Transaction Volume:", transaction)) %>%
  layout(xaxis = list(title = "Day_of_week", 
                        type = "factor",
                        categoryorder = "factor",
                        categoryarray = cc_data_cleaned$weekday[order(cc_data_cleaned[['daynumber']])],
                        showgrid = TRUE,
                        showticklabels = TRUE), 
                        yaxis = list(title = "Transaction volume"))

cc_timegroup_vol <-shared_data %>%
  plot_ly( width=700, height=500) %>%
  group_by(weekday,timegroup,location) %>%
  summarize("transaction" = n()) %>%
  add_trace(x = ~weekday, y = ~transaction, color = ~timegroup, type = 'bar',hoverinfo = 'text',
            hovertext  = ~paste("<br> Time:", timegroup,
                                "<br>Transaction Volume:", transaction)) %>%
  layout(xaxis = list(title = "Time",  type = "factor",
                      categoryorder = "factor",
                      categoryarray = cc_data_cleaned$weekday[order(cc_data_cleaned[['daynumber']])],
                      showgrid = TRUE,
                      showticklabels = TRUE), 
                      yaxis = list(title = "Transaction volume"))



bscols(widths = c(10,4),
  list(
    filter_select("location", "Please Specify the location", shared_data, group =  ~location, multiple = F),
    datatable(shared_data) %>% formatDate(1, method = 'toLocaleDateString'),
  cc_wkday_vol,
  cc_timegroup_vol
))
```

#### GeoVisual Analysis

1) **Trajectory analysis**- To visualize the path traveled by each car. We have employed both the use of an interactive map and static facet map.
    - Interactive map- Clicking on any point in the trajectory allows us to see the CarID, day and timestamp of the respective point in the route.
    - Facet map- This allows us to visualize a single variable with many levels and arrange the plots in a more space efficient manner for easy comparison and analysis.

```{r}
##Plotting GPS paths
gps_path_selected <- gps_path_cleaned %>%
  filter(id == 1, day == 6)

tmap_mode("view")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1, g = 2, b = 3, alpha = NA, saturation = 1, interpolate = TRUE, max.value = 255) +
  tm_shape(gps_path_selected) +
  tm_lines(col= "red")
```

```{r, layout="l-body-outset", fig.width=6, fig.height=20}
##Facet map
gps_path_selected <- gps_path_cleaned %>%
  filter(hour == 12)
  
tmap_mode("plot")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1, g = 2, b = 3, alpha = NA, saturation = 1, interpolate = TRUE, max.value = 255) +
  tm_shape(gps_path_selected) +
  tm_lines() +
  tm_facets(by = "id", ncol = 3)
```

#### Network Visualisation and Analysis

1) **Network analysis**- To visualize the possible associations between employees by analyzing their transaction history. Bipartite graphs are used as we are provided with credit card information showing employees transactions with each location. As there is no information on interactions between employees themselves, we will utilize a bipartite graph where two sets of vertices which are connected to each other, but not within themselves.

We have employed both the use of an interactive and static visualization.
    - Interactive network graph- This allows the user to select any node on the graph and observe the interactions between this node and the other nodes will be highlighted, while the other nodes will be dulled. The interactive filtering option also allows user to select by department and id. In order to assess if the employees have crossed paths during their visits to certain locations, we will use the interactive network graph concurrently with an interactive datatable where filters have been enabled to allow filtering for the respective location.
    
    - Facet network graph- This allows us to visualize a single variable with many levels and arrange the plots in a more space efficient manner for easy comparison and analysis. In this case, we have presented a facet graph by day and timegroup, allowing users to observe the interactions between nodes for each timegroup in day 6.

```{r, layout="l-body-outset", fig.width=10, fig.height=9}
##Interactive viz
visNetwork(cc_nodes, cc_edges, height = "800px", width = "100%") %>%
  visIgraphLayout(layout = "layout_in_circle") %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE, selectedBy = "group") %>%
  visLegend() %>%
  visGroups(groupname = "Security", color = "#FFFFA3") %>%
  visGroups(groupname = "Engineering", color = "#FFAFB1") %>%
  visGroups(groupname = "Information Technology", color = "#A1EC76") %>%
  visGroups(groupname = "Facilities", color = "#F0B3F5") %>%
  visGroups(groupname = "Executive", color = "#FF3333") %>%
  visLayout(randomSeed = 123)
```

```{r, fig.height=6}
cc_data_cleaned_matched <- subset(cc_data_cleaned_matched, select = -c(timestamp, day, price))
DT::datatable(cc_data_cleaned_matched, fillContainer = T, extensions='Scroller', filter = "top", options = list(scrollX=TRUE, autoWidth=TRUE, scroller=TRUE, scrollY = '450px'))
```

```{r, layout="l-body-outset", fig.width=12, fig.height=10}
##Facet
cc_edges <- cc_edges %>%
  filter(day == 6)

cc_graph <- tbl_graph(nodes = cc_nodes,
                      edges = cc_edges,
                      directed = FALSE)

set_graph_style()
g <- ggraph(cc_graph, layout = "nicely") + 
  geom_edge_link(aes(width = weight), alpha=0.2) +
  scale_edge_width(range = c(0.1, 5)) +
  geom_node_point(aes(colour = group), size = 2) 

g + facet_edges(day~timegroup) +
th_foreground(foreground = "grey80",
border = TRUE) +
theme(legend.position = 'bottom')
```
